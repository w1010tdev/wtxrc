<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>wtxrc — 远程控制</title>
    <!-- Element Plus 样式 -->
    <link rel="stylesheet" href="https://unpkg.com/element-plus/dist/index.css">
    <link rel="stylesheet" href="/static/css/style.css">
    <!-- Vue 3 -->
    <script src="https://unpkg.com/vue@3/dist/vue.global.prod.js"></script>
    <!-- Element Plus -->
    <script src="https://unpkg.com/element-plus"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.0.1/socket.io.js"></script>
</head>
<body>
    {% raw %}
    <div id="app">
        <div id="controls-bar">
            <span class="brand">wtxrc</span>
            <div class="mode-badge" v-if="mode === 'driving'">
                <el-tag type="warning" size="small">🎮 驾驶模式</el-tag>
            </div>
            <div class="actions">
                <el-button 
                    v-if="mode === 'driving' && !isEditing"
                    type="info"
                    size="small"
                    @click="openDrivingConfig"
                >
                    ⚙️ 驾驶配置
                </el-button>
                <el-button 
                    :type="isEditing ? 'warning' : 'primary'"
                    size="small"
                    @click="toggleEditMode"
                >
                    <span v-if="!isEditing">⚙️ 编辑</span>
                    <span v-else>✓ 完成</span>
                </el-button>
                <el-button 
                    v-if="isEditing"
                    type="success"
                    size="small"
                    @click="addNewButton"
                >
                    + 添加按钮
                </el-button>
                <el-button 
                    v-if="isEditing && mode === 'driving'"
                    type="success"
                    size="small"
                    @click="addNewSlider"
                >
                    + 添加拖动条
                </el-button>
                <el-button 
                    v-show="isEditing"
                    type="primary"
                    size="small"
                    @click="saveLayout"
                >
                    💾 保存
                </el-button>
            </div>
        </div>
        
        <!-- 主设备对话（驾驶模式） -->
        <el-dialog
            v-model="showMainDeviceDialog"
            title="设为主设备？"
            :width="dialogWidth"
            :close-on-click-modal="false"
        >
            <p style="margin-bottom: 12px;">在驾驶模式下，主设备会发送陀螺仪数据用于转向控制。</p>
            <p v-if="hasExistingMainDevice" style="color: var(--el-color-warning);">注意：当前已有其它设备被设置为主设备。</p>
            <template #footer>
                <div style="display: flex; gap: 8px; flex-wrap: wrap; justify-content: flex-end;">
                    <el-button size="default" @click="setAsMainDevice(false)">普通控制器</el-button>
                    <el-button type="primary" size="default" @click="setAsMainDevice(true)">设为主设备</el-button>
                </div>
            </template>
        </el-dialog>

        <!-- 驾驶模式配置对话框 -->
        <el-dialog
            v-model="showDrivingConfigDialog"
            title="驾驶设置 - 统一轴映射配置"
            :width="'90%'"
            :close-on-click-modal="false"
            style="max-width: 900px;"
        >
            <el-form :model="drivingConfig" label-position="top">
                <el-divider content-position="left">Xbox 手柄轴配置</el-divider>
                <p style="color: var(--el-color-info); font-size: 13px; margin-bottom: 12px;">
                    为每个 Xbox 手柄轴配置输入源（陀螺仪或拖动条）、峰值和死区
                </p>
                
                <!-- 轴配置表格 -->
                <el-table :data="axisConfigList" border style="width: 100%; margin-bottom: 20px;">
                    <el-table-column prop="axis" label="手柄轴" width="120">
                        <template #default="scope">
                            <strong>{{ getAxisDisplayName(scope.row.axis) }}</strong>
                        </template>
                    </el-table-column>
                    <el-table-column label="输入源" width="160">
                        <template #default="scope">
                            <el-select v-model="scope.row.source_type" size="small" @change="onAxisSourceTypeChange(scope.row)">
                                <el-option label="未绑定" value="none"></el-option>
                                <el-option label="陀螺仪" value="gyro"></el-option>
                                <el-option label="拖动条" value="slider"></el-option>
                            </el-select>
                        </template>
                    </el-table-column>
                    <el-table-column label="源选择" width="150">
                        <template #default="scope">
                            <el-select 
                                v-if="scope.row.source_type === 'gyro'" 
                                v-model="scope.row.source_id" 
                                size="small"
                                placeholder="选择陀螺仪轴"
                            >
                                <el-option label="Gamma (左右)" value="gamma"></el-option>
                                <el-option label="Beta (前后)" value="beta"></el-option>
                                <el-option label="Alpha (旋转)" value="alpha"></el-option>
                            </el-select>
                            <el-select 
                                v-else-if="scope.row.source_type === 'slider'" 
                                v-model="scope.row.source_id" 
                                size="small"
                                placeholder="选择拖动条"
                            >
                                <el-option 
                                    v-for="slider in getAvailableSlidersForAxis(scope.row.axis)" 
                                    :key="slider.id" 
                                    :label="slider.displayLabel" 
                                    :value="slider.id"
                                    :disabled="slider.disabled"
                                ></el-option>
                            </el-select>
                            <span v-else style="color: var(--el-color-info); font-size: 12px;">-</span>
                        </template>
                    </el-table-column>
                    <el-table-column label="峰值" width="100">
                        <template #default="scope">
                            <el-input-number 
                                v-model="scope.row.peak_value" 
                                :min="0.1" 
                                :max="1" 
                                :step="0.1" 
                                size="small"
                                :disabled="scope.row.source_type === 'none'"
                            ></el-input-number>
                        </template>
                    </el-table-column>
                    <el-table-column label="死区" width="100">
                        <template #default="scope">
                            <el-input-number 
                                v-model="scope.row.deadzone" 
                                :min="0" 
                                :max="0.5" 
                                :step="0.05" 
                                size="small"
                                :disabled="scope.row.source_type === 'none'"
                            ></el-input-number>
                        </template>
                    </el-table-column>
                    <el-table-column label="陀螺仪范围" width="130">
                        <template #default="scope">
                            <el-input-number 
                                v-model="scope.row.gyro_range" 
                                :min="1" 
                                :max="180" 
                                :step="1" 
                                size="small"
                                :disabled="scope.row.source_type !== 'gyro'"
                            ></el-input-number>
                        </template>
                    </el-table-column>
                </el-table>
                
                <el-alert 
                    title="提示" 
                    type="info" 
                    :closable="false"
                    style="margin-top: 10px;"
                >
                    <ul style="margin: 0; padding-left: 20px; font-size: 13px;">
                        <li>峰值：轴的最大输出值（1.0 = 100%）</li>
                        <li>死区：忽略小幅输入变化的阈值（防止漂移）</li>
                        <li>陀螺仪范围：转动多少度达到满输出（如 90 度表示转动 90 度输出从 0 到 1）</li>
                        <li>每个拖动条只能绑定到一个轴，已绑定到其他轴的拖动条在下拉列表中会被禁用</li>
                    </ul>
                </el-alert>
            </el-form>
            <template #footer>
                <div style="display: flex; gap: 8px; justify-content: flex-end;">
                    <el-button size="default" @click="showDrivingConfigDialog = false">取消</el-button>
                    <el-button type="primary" size="default" @click="saveDrivingConfig(); showDrivingConfigDialog = false;">保存</el-button>
                </div>
            </template>
        </el-dialog>
        
        <!-- 按钮编辑对话 -->
        <el-dialog
            v-model="showEditDialog"
            :title="editingButton.type === 'slider' ? '拖动条配置' : '按钮配置'"
            :width="dialogWidth"
            :close-on-click-modal="false"
        >
            <el-form :model="editingButton" label-position="top">
                <el-form-item label="控件类型" v-if="!editingButton.id">
                    <el-radio-group v-model="editingButton.type">
                        <el-radio-button label="button">按钮</el-radio-button>
                        <el-radio-button label="slider" v-if="mode === 'driving'">拖动条</el-radio-button>
                    </el-radio-group>
                </el-form-item>
                
                <el-form-item :label="editingButton.type === 'slider' ? '拖动条标签' : '按钮标签'">
                    <el-input v-model="editingButton.label" placeholder="输入名称"></el-input>
                </el-form-item>
                
                <!-- 拖动条特有配置 -->
                <template v-if="editingButton.type === 'slider'">
                    <el-form-item label="方向">
                        <el-radio-group v-model="editingButton.orientation" @change="onSliderOrientationChange">
                            <el-radio-button label="horizontal">横向</el-radio-button>
                            <el-radio-button label="vertical">竖向</el-radio-button>
                        </el-radio-group>
                    </el-form-item>
                    
                    <el-form-item label="值域模式">
                        <el-radio-group v-model="editingButton.rangeMode">
                            <el-radio-button label="unipolar">单极 (0 到 1)</el-radio-button>
                            <el-radio-button label="bipolar">双极 (-1 到 1)</el-radio-button>
                        </el-radio-group>
                        <p class="key-hint">单极模式：居中时为 0.5，底部为 0，顶部为 1</p>
                        <p class="key-hint">双极模式：居中时为 0，底部为 -1，顶部为 1</p>
                    </el-form-item>
                    
                    <el-form-item label="自动归中">
                        <el-switch v-model="editingButton.autoCenter"></el-switch>
                        <p class="key-hint">释放拖动条后是否自动回到中间位置</p>
                    </el-form-item>
                    
                    <el-alert 
                        title="轴绑定配置" 
                        type="info" 
                        :closable="false"
                        description="拖动条的轴绑定现在统一在【驾驶配置】中设置。请点击顶部的【⚙️ 驾驶配置】按钮进行配置。"
                        style="margin-top: 10px;"
                    ></el-alert>
                </template>
                
                <!-- 按钮特有配置 -->
                <el-form-item label="按键绑定" v-if="editingButton.type !== 'slider'">
                    <div class="key-tags">
                        <el-tag
                            v-for="(key, index) in editingButton.keys"
                            :key="index"
                            closable
                            size="default"
                            @close="removeKey(index)"
                        >
                            {{ key }}
                        </el-tag>
                        <el-tag v-if="editingButton.keys.length === 0" type="info" size="small">未配置按键</el-tag>
                    </div>
                    <div class="key-input-group">
                        <el-select 
                            v-model="selectedModifiers"
                            placeholder="修饰键"
                            clearable
                            multiple
                            collapse-tags
                            size="default"
                        >
                            <el-option 
                                v-for="mod in modifierKeys" 
                                :key="mod" 
                                :label="mod.toUpperCase()"
                                :value="mod"
                            ></el-option>
                        </el-select>
                        <el-select 
                            v-model="selectedSpecialKey" 
                            placeholder="特殊按键"
                            clearable
                            filterable
                            size="default"
                        >
                            <el-option 
                                v-for="key in specialKeys" 
                                :key="key" 
                                :label="key.toUpperCase()" 
                                :value="key"
                            ></el-option>
                        </el-select>
                        <el-input 
                            v-model="customKeyInput" 
                            placeholder="自定义按键"
                            size="default"
                            @keyup.enter="addKey"
                        ></el-input>
                        <el-button type="primary" size="default" @click="addKey">添加按键</el-button>
                    </div>
                    <p class="key-hint">先选择修饰键（ctrl、alt、shift），再添加主按键（例如用 del 表示 Ctrl+Alt+Del）</p>
                </el-form-item>
                
                <el-form-item label="按钮样式">
                    <el-radio-group v-model="editingButton.colorIndex">
                        <el-radio-button 
                            v-for="(color, index) in BUTTON_COLORS" 
                            :key="index" 
                            :label="index"
                        >
                            <span :style="{ color: color.color }">●</span> {{ color.name }}
                        </el-radio-button>
                    </el-radio-group>
                </el-form-item>
                
                <el-form-item label="按钮大小">
                    <div class="size-inputs">
                        <div class="size-input-row">
                            <span>宽度：</span>
                            <el-slider 
                                v-model="editingButton.width" 
                                :min="50" 
                                :max="200" 
                                :step="10"
                                show-input
                                :show-input-controls="false"
                            ></el-slider>
                        </div>
                        <div class="size-input-row">
                            <span>高度：</span>
                            <el-slider 
                                v-model="editingButton.height" 
                                :min="50" 
                                :max="200" 
                                :step="10"
                                show-input
                                :show-input-controls="false"
                            ></el-slider>
                        </div>
                    </div>
                    <p class="key-hint">也可以在编辑模式下拖拽角点来调整大小</p>
                </el-form-item>
            </el-form>
            <template #footer>
                <div style="display: flex; gap: 8px; flex-wrap: wrap; justify-content: space-between;">
                    <el-button type="danger" size="default" @click="deleteButton" v-if="editingButton.id">删除</el-button>
                    <div style="display: flex; gap: 8px; flex-wrap: wrap;">
                        <el-button size="default" @click="showEditDialog = false">取消</el-button>
                        <el-button type="primary" size="default" @click="saveButtonEdit">保存</el-button>
                    </div>
                </div>
            </template>
        </el-dialog>
        
        <!-- Canvas-based Game Pad Area -->
        <div id="game-pad-container">
            <canvas ref="canvasRef" id="game-pad-canvas"></canvas>
            <div v-if="isEditing" class="edit-hint">
                <el-tag type="info" size="small">拖动移动 • 拖拽角点调整大小 • 双击编辑</el-tag>
            </div>
        </div>
        
        <!-- 陀螺仪状态（驾驶模式） -->
        <div v-if="mode === 'driving' && isMainDevice" class="gyro-status">
            <el-tag type="success">🎮 主设备 - 陀螺仪已激活</el-tag>
            <div class="gyro-values">
                α: {{ gyroData.alpha.toFixed(1) }}° 
                β: {{ gyroData.beta.toFixed(1) }}° 
                γ: {{ gyroData.gamma.toFixed(1) }}°
            </div>
        </div>
    </div>
    {% endraw %}

    <script src="/static/js/main.js"></script>
</body>
</html>
