<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>wtxrc — 远程控制</title>
    <!-- Element Plus 样式 -->
    <link rel="stylesheet" href="https://unpkg.com/element-plus/dist/index.css">
    <link rel="stylesheet" href="/static/css/style.css">
    <!-- Vue 3 -->
    <script src="https://unpkg.com/vue@3/dist/vue.global.prod.js"></script>
    <!-- Element Plus -->
    <script src="https://unpkg.com/element-plus"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.0.1/socket.io.js"></script>
</head>
<body>
    {% raw %}
    <div id="app">
        <div id="controls-bar">
            <span class="brand">wtxrc</span>
            <div class="mode-badge" v-if="mode === 'driving'">
                <el-tag type="warning" size="small">🎮 驾驶模式</el-tag>
            </div>
            <div class="actions">
                <el-button 
                    v-if="mode === 'driving' && !isEditing"
                    type="info"
                    size="small"
                    @click="openDrivingConfig"
                >
                    ⚙️ 驾驶配置
                </el-button>
                <el-button 
                    :type="isEditing ? 'warning' : 'primary'"
                    size="small"
                    @click="toggleEditMode"
                >
                    <span v-if="!isEditing">⚙️ 编辑</span>
                    <span v-else>✓ 完成</span>
                </el-button>
                <el-button 
                    v-if="isEditing"
                    type="success"
                    size="small"
                    @click="addNewButton"
                >
                    + 添加按钮
                </el-button>
                <el-button 
                    v-if="isEditing && mode === 'driving'"
                    type="success"
                    size="small"
                    @click="addNewSlider"
                >
                    + 添加拖动条
                </el-button>
                <el-button 
                    v-show="isEditing"
                    type="primary"
                    size="small"
                    @click="saveLayout"
                >
                    💾 保存
                </el-button>
            </div>
        </div>
        
        <!-- 主设备对话（驾驶模式） -->
        <el-dialog
            v-model="showMainDeviceDialog"
            title="设为主设备？"
            :width="dialogWidth"
            :close-on-click-modal="false"
        >
            <p style="margin-bottom: 12px;">在驾驶模式下，主设备会发送陀螺仪数据用于转向控制。</p>
            <p v-if="hasExistingMainDevice" style="color: var(--el-color-warning);">注意：当前已有其它设备被设置为主设备。</p>
            <template #footer>
                <div style="display: flex; gap: 8px; flex-wrap: wrap; justify-content: flex-end;">
                    <el-button size="default" @click="setAsMainDevice(false)">普通控制器</el-button>
                    <el-button type="primary" size="default" @click="setAsMainDevice(true)">设为主设备</el-button>
                </div>
            </template>
        </el-dialog>

        <!-- 驾驶模式配置对话框 -->
        <el-dialog
            v-model="showDrivingConfigDialog"
            title="驾驶模式配置"
            :width="dialogWidth"
            :close-on-click-modal="false"
        >
            <el-form :model="drivingConfig" label-position="top">
                <el-divider content-position="left">陀螺仪轴映射</el-divider>
                <p style="color: var(--el-color-info); font-size: 13px; margin-bottom: 12px;">
                    配置陀螺仪的每个轴如何映射到 Xbox 手柄轴
                </p>
                
                <el-form-item label="Gamma（左右倾斜）映射到">
                    <el-select v-model="drivingConfig.gyro_axis_mapping.gamma" placeholder="选择手柄轴" clearable>
                        <el-option label="左摇杆 X 轴" value="left_x"></el-option>
                        <el-option label="左摇杆 Y 轴" value="left_y"></el-option>
                        <el-option label="右摇杆 X 轴" value="right_x"></el-option>
                        <el-option label="右摇杆 Y 轴" value="right_y"></el-option>
                        <el-option label="左扳机" value="left_trigger"></el-option>
                        <el-option label="右扳机" value="right_trigger"></el-option>
                    </el-select>
                </el-form-item>
                
                <el-form-item label="Beta（前后倾斜）映射到">
                    <el-select v-model="drivingConfig.gyro_axis_mapping.beta" placeholder="选择手柄轴" clearable>
                        <el-option label="左摇杆 X 轴" value="left_x"></el-option>
                        <el-option label="左摇杆 Y 轴" value="left_y"></el-option>
                        <el-option label="右摇杆 X 轴" value="right_x"></el-option>
                        <el-option label="右摇杆 Y 轴" value="right_y"></el-option>
                        <el-option label="左扳机" value="left_trigger"></el-option>
                        <el-option label="右扳机" value="right_trigger"></el-option>
                    </el-select>
                </el-form-item>
                
                <el-form-item label="Alpha（Z轴旋转）映射到">
                    <el-select v-model="drivingConfig.gyro_axis_mapping.alpha" placeholder="选择手柄轴" clearable>
                        <el-option label="左摇杆 X 轴" value="left_x"></el-option>
                        <el-option label="左摇杆 Y 轴" value="left_y"></el-option>
                        <el-option label="右摇杆 X 轴" value="right_x"></el-option>
                        <el-option label="右摇杆 Y 轴" value="right_y"></el-option>
                        <el-option label="左扳机" value="left_trigger"></el-option>
                        <el-option label="右扳机" value="right_trigger"></el-option>
                    </el-select>
                </el-form-item>
            </el-form>
            <template #footer>
                <div style="display: flex; gap: 8px; justify-content: flex-end;">
                    <el-button size="default" @click="showDrivingConfigDialog = false">取消</el-button>
                    <el-button type="primary" size="default" @click="saveDrivingConfig(); showDrivingConfigDialog = false;">保存</el-button>
                </div>
            </template>
        </el-dialog>
        
        <!-- 按钮编辑对话 -->
        <el-dialog
            v-model="showEditDialog"
            :title="editingButton.type === 'slider' ? '拖动条配置' : '按钮配置'"
            :width="dialogWidth"
            :close-on-click-modal="false"
        >
            <el-form :model="editingButton" label-position="top">
                <el-form-item label="控件类型" v-if="!editingButton.id">
                    <el-radio-group v-model="editingButton.type">
                        <el-radio-button label="button">按钮</el-radio-button>
                        <el-radio-button label="slider" v-if="mode === 'driving'">拖动条</el-radio-button>
                    </el-radio-group>
                </el-form-item>
                
                <el-form-item :label="editingButton.type === 'slider' ? '拖动条标签' : '按钮标签'">
                    <el-input v-model="editingButton.label" placeholder="输入名称"></el-input>
                </el-form-item>
                
                <!-- 拖动条特有配置 -->
                <template v-if="editingButton.type === 'slider'">
                    <el-form-item label="方向">
                        <el-radio-group v-model="editingButton.orientation" @change="onSliderOrientationChange">
                            <el-radio-button label="horizontal">横向</el-radio-button>
                            <el-radio-button label="vertical">竖向</el-radio-button>
                        </el-radio-group>
                    </el-form-item>
                    
                    <el-form-item label="绑定到 Xbox 轴">
                        <el-select v-model="editingButton.axis" placeholder="选择手柄轴">
                            <el-option label="左摇杆 X 轴" value="left_x"></el-option>
                            <el-option label="左摇杆 Y 轴" value="left_y"></el-option>
                            <el-option label="右摇杆 X 轴" value="right_x"></el-option>
                            <el-option label="右摇杆 Y 轴" value="right_y"></el-option>
                            <el-option label="左扳机" value="left_trigger"></el-option>
                            <el-option label="右扳机" value="right_trigger"></el-option>
                        </el-select>
                    </el-form-item>
                    
                    <el-form-item label="自动归中">
                        <el-switch v-model="editingButton.autoCenter"></el-switch>
                        <p class="key-hint">释放拖动条后是否自动回到中间位置</p>
                    </el-form-item>
                </template>
                
                <!-- 按钮特有配置 -->
                <el-form-item label="按键绑定" v-if="editingButton.type !== 'slider'">
                    <div class="key-tags">
                        <el-tag
                            v-for="(key, index) in editingButton.keys"
                            :key="index"
                            closable
                            size="default"
                            @close="removeKey(index)"
                        >
                            {{ key }}
                        </el-tag>
                        <el-tag v-if="editingButton.keys.length === 0" type="info" size="small">未配置按键</el-tag>
                    </div>
                    <div class="key-input-group">
                        <el-select 
                            v-model="selectedModifiers"
                            placeholder="修饰键"
                            clearable
                            multiple
                            collapse-tags
                            size="default"
                        >
                            <el-option 
                                v-for="mod in modifierKeys" 
                                :key="mod" 
                                :label="mod.toUpperCase()"
                                :value="mod"
                            ></el-option>
                        </el-select>
                        <el-select 
                            v-model="selectedSpecialKey" 
                            placeholder="特殊按键"
                            clearable
                            filterable
                            size="default"
                        >
                            <el-option 
                                v-for="key in specialKeys" 
                                :key="key" 
                                :label="key.toUpperCase()" 
                                :value="key"
                            ></el-option>
                        </el-select>
                        <el-input 
                            v-model="customKeyInput" 
                            placeholder="自定义按键"
                            size="default"
                            @keyup.enter="addKey"
                        ></el-input>
                        <el-button type="primary" size="default" @click="addKey">添加按键</el-button>
                    </div>
                    <p class="key-hint">先选择修饰键（ctrl、alt、shift），再添加主按键（例如用 del 表示 Ctrl+Alt+Del）</p>
                </el-form-item>
                
                <el-form-item label="按钮样式">
                    <el-radio-group v-model="editingButton.colorIndex">
                        <el-radio-button 
                            v-for="(color, index) in BUTTON_COLORS" 
                            :key="index" 
                            :label="index"
                        >
                            <span :style="{ color: color.color }">●</span> {{ color.name }}
                        </el-radio-button>
                    </el-radio-group>
                </el-form-item>
                
                <el-form-item label="按钮大小">
                    <div class="size-inputs">
                        <div class="size-input-row">
                            <span>宽度：</span>
                            <el-slider 
                                v-model="editingButton.width" 
                                :min="50" 
                                :max="200" 
                                :step="10"
                                show-input
                                :show-input-controls="false"
                            ></el-slider>
                        </div>
                        <div class="size-input-row">
                            <span>高度：</span>
                            <el-slider 
                                v-model="editingButton.height" 
                                :min="50" 
                                :max="200" 
                                :step="10"
                                show-input
                                :show-input-controls="false"
                            ></el-slider>
                        </div>
                    </div>
                    <p class="key-hint">也可以在编辑模式下拖拽角点来调整大小</p>
                </el-form-item>
            </el-form>
            <template #footer>
                <div style="display: flex; gap: 8px; flex-wrap: wrap; justify-content: space-between;">
                    <el-button type="danger" size="default" @click="deleteButton" v-if="editingButton.id">删除</el-button>
                    <div style="display: flex; gap: 8px; flex-wrap: wrap;">
                        <el-button size="default" @click="showEditDialog = false">取消</el-button>
                        <el-button type="primary" size="default" @click="saveButtonEdit">保存</el-button>
                    </div>
                </div>
            </template>
        </el-dialog>
        
        <!-- Canvas-based Game Pad Area -->
        <div id="game-pad-container">
            <canvas ref="canvasRef" id="game-pad-canvas"></canvas>
            <div v-if="isEditing" class="edit-hint">
                <el-tag type="info" size="small">拖动移动 • 拖拽角点调整大小 • 双击编辑</el-tag>
            </div>
        </div>
        
        <!-- 陀螺仪状态（驾驶模式） -->
        <div v-if="mode === 'driving' && isMainDevice" class="gyro-status">
            <el-tag type="success">🎮 主设备 - 陀螺仪已激活</el-tag>
            <div class="gyro-values">
                α: {{ gyroData.alpha.toFixed(1) }}° 
                β: {{ gyroData.beta.toFixed(1) }}° 
                γ: {{ gyroData.gamma.toFixed(1) }}°
            </div>
        </div>
    </div>
    {% endraw %}

    <script src="/static/js/main.js"></script>
</body>
</html>
