# 新功能说明

## 1. 陀螺仪轴映射配置

### 功能描述
在驾驶模式中，现在可以自定义陀螺仪的每个轴如何映射到 Xbox 手柄的轴上。

### 使用方法
1. 进入驾驶模式
2. 点击"驾驶配置"按钮
3. 在弹出的对话框中配置：
   - **Gamma（左右倾斜）** - 通常用于转向
   - **Beta（前后倾斜）** - 通常用于油门/刹车
   - **Alpha（Z轴旋转）** - 可选配置

### 可选的 Xbox 轴
- 左摇杆 X 轴 (left_x)
- 左摇杆 Y 轴 (left_y)
- 右摇杆 X 轴 (right_x)
- 右摇杆 Y 轴 (right_y)
- 左扳机 (left_trigger)
- 右扳机 (right_trigger)

### 配置文件
配置保存在 `config/buttons.json` 中的 `driving_config.gyro_axis_mapping` 字段。

**注意：修改配置后需要重启服务器才能生效。**

---

## 2. 拖动条控件

### 功能描述
新增拖动条（Slider）控件类型，与按钮区分开来。拖动条可以模拟游戏中的其他轴，适用于陀螺仪轴不够的情况。

### 特性
- **方向选择**：支持横向和竖向两种方向
- **自动归中**：可配置释放后是否自动回到中间位置
- **轴绑定**：指定绑定到 Xbox 手柄的哪个轴
- **实时传输**：拖动时通过 WebSocket 实时广播到电脑

### 使用方法

#### 添加拖动条
1. 进入编辑模式
2. 点击"+ 添加拖动条"按钮（仅在驾驶模式下显示）
3. 配置拖动条属性：
   - 标签名称
   - 方向（横向/竖向）
   - 绑定的 Xbox 轴
   - 是否自动归中
   - 颜色和大小

#### 编辑拖动条
1. 在编辑模式下双击拖动条
2. 修改配置
3. 保存

#### 使用拖动条
1. 非编辑模式下，拖动滑块可以改变值（范围：-1.0 到 1.0）
2. 值会实时通过 WebSocket 发送到后端
3. 后端将值应用到配置的 Xbox 轴上
4. 如果启用了自动归中，释放后会自动回到 0.0

### 后端逻辑
- 拖动条配置保存在 `config/buttons.json` 的 `driving_config.sliders` 数组中
- 服务器启动时会从配置中读取拖动条信息
- 拖动条的值通过 `slider_value` WebSocket 事件传输
- 后端使用 `VirtualJoystick.set_axis()` 方法将值应用到虚拟手柄

**重要：修改拖动条的轴绑定配置后，需要重启服务器才能生效。**

---

## 技术实现

### 前端
- `static/js/main.js`：
  - 添加拖动条绘制函数 `drawSlider()`
  - 添加拖动条交互处理 `handleSliderMove()`
  - 支持拖动条编辑和保存
  - 添加驾驶配置对话框

### 后端
- `server/app.py`：
  - 添加 `/api/update_driving_config` API 端点
  - 添加 `slider_value` WebSocket 事件处理
  - 更新 `gyro_data` 处理以支持自定义轴映射
  - 添加虚拟摇杆初始化逻辑

- `server/joystick_manager.py`：
  - 添加 `set_axis()` 方法，支持设置任意轴
  - 维护轴状态以支持多轴同时控制

### 配置文件
- `config/config.py`：
  - 扩展 `DRIVING_CONFIG` 以支持 `gyro_axis_mapping` 和 `sliders`

---

## 使用示例

### 场景1：赛车游戏
- **陀螺仪**：Gamma 映射到左摇杆 X 轴（转向）
- **拖动条1（竖向）**：映射到右扳机（油门）
- **拖动条2（竖向）**：映射到左扳机（刹车）

### 场景2：飞行模拟器
- **陀螺仪**：
  - Gamma → 左摇杆 X 轴（滚转）
  - Beta → 左摇杆 Y 轴（俯仰）
  - Alpha → 右摇杆 X 轴（偏航）
- **拖动条1（竖向）**：映射到右扳机（油门）

---

## 注意事项

1. **重启服务器**：修改陀螺仪轴映射或拖动条轴绑定后，必须重启服务器
2. **驾驶模式**：拖动条功能仅在驾驶模式 (`MODE = "driving"`) 下可用
3. **轴冲突**：避免将多个控制源（陀螺仪/拖动条）映射到同一个轴，可能导致冲突
4. **虚拟手柄**：确保已正确安装虚拟手柄驱动（Windows: ViGEmBus, Linux: uinput）

---

## 更新日志

**版本：2026-01-17**
- ✅ 添加陀螺仪轴映射配置界面
- ✅ 添加拖动条控件类型
- ✅ 支持拖动条横向/竖向方向选择
- ✅ 支持拖动条自动归中功能
- ✅ 支持拖动条绑定到任意 Xbox 轴
- ✅ 实时 WebSocket 传输拖动条值
- ✅ 后端虚拟摇杆支持自定义轴设置
